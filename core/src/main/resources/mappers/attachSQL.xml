<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.nagesoft.postcode.common.dao.AttachDao">

	<resultMap id="attachResult" type="com.nagesoft.postcode.common.model.Attach">
		<id property="id" column="SEQ"/>
		<result   property="displayName"      column="SOURCE_FILE_NAME"   />
		<result   property="savedName"        column="FILE_NAME"          />
		<result   property="savedDir"         column="FILE_PATH"          />
		<result   property="fileType"         column="EXTENSION"          />
		<result   property="refType"          column="BUSINESS_CODE"      typeHandler="refTypeEnumHandler"  />
		<result   property="typeKey"          column="TYPE"               />
		<result   property="refKey"           column="REFERENCE_SEQ"       />
		<result   property="fileSize"         column="FILE_SIZE"          />
		<result   property="sortOrder"        column="SORT_ORDER"         />
		<result   property="regUser.id"       column="REG_SEQ"             />
		<result   property="regDate"          column="REG_DATE"           />
		<result   property="regUser.name"     column="REG_USER_NM"        />
		<result   property="regUser.userID"   column="REG_USER_SEQ"        />
		<result   property="modUser.id"       column="MOD_SEQ"             />
		<result   property="modDate"          column="MOD_DT"             />
		<result   property="modUser.name"     column="MOD_USER_NM"        />
		<result   property="modUser.userID"   column="MOD_USER_SEQ"        />
	</resultMap>

	<!-- 파일 목록 조회 쿼리 -->
	<sql id="selectQuery">
		SELECT F.SEQ
			,F.SOURCE_FILE_NAME
			,F.FILE_NAME
			,F.FILE_PATH
			,F.BUSINESS_CODE
			,F.REFERENCE_SEQ
			,F.TYPE
			,F.EXTENSION
			,F.FILE_SIZE
			,F.SORT_ORDER
			,F.EXTRA1
			,F.EXTRA2
			,F.REG_USER_SEQ
			,F.REG_DATE
			,F.MOD_USER_SEQ
			,F.MOD_DATE
		FROM GC_ATTACH F
	</sql>


	<!-- 파일 저장 -->
	<insert id="addAttach" parameterType="attach" useGeneratedKeys="true" keyProperty="id">
		INSERT INTO GC_ATTACH (
			SOURCE_FILE_NAME,
			FILE_NAME,
			FILE_PATH,
			EXTENSION,
			BUSINESS_CODE,
			TYPE,
			REFERENCE_SEQ,
			FILE_SIZE,
			SORT_ORDER,
			REG_DATE
		) VALUES (
			#{displayName,jdbcType=VARCHAR},
			#{savedName,jdbcType=VARCHAR},
			#{savedDir,jdbcType=VARCHAR},
			#{fileType,jdbcType=VARCHAR},
			#{refType,typeHandler=refTypeEnumHandler},
			#{typeKey,jdbcType=VARCHAR},
			#{refKey,jdbcType=NUMERIC},
			#{fileSize,jdbcType=NUMERIC},
			#{sortOrder,jdbcType=NUMERIC},
			NOW()
		)
		<selectKey keyProperty="id" order="AFTER" resultType="java.lang.Long">
		    SELECT LAST_INSERT_ID()
		</selectKey>
	</insert>

	<!-- 등록 기준으로 정렬된 파일 목록 -->
	<select id="listAttach" resultMap="attachResult">
		<include refid="selectQuery" />

		WHERE  F.BUSINESS_CODE = #{refType, typeHandler=refTypeEnumHandler}
		   AND F.REFERENCE_SEQ = #{reference}
		ORDER BY F.SEQ DESC
	</select>

	<!-- 정렬 기준을 적용한 파일 목록 -->
	<select id="listAttachSort" resultMap="attachResult">
		<include refid="selectQuery" />

		WHERE  F.BUSINESS_CODE = #{refType, typeHandler=refTypeEnumHandler}
		   AND F.REFERENCE_SEQ = #{reference}
		ORDER BY F.SORT_ORDER ASC
	</select>

	<!-- 특정 첨부 파일 조회 -->
	<select id="getAttach" resultMap="attachResult">
		<include refid="selectQuery" />

		WHERE  F.SEQ = #{id}
	</select>

	<!-- 특정 파일 삭제 -->
	<delete id="deleteAttach" parameterType="long">
		DELETE
		FROM   GC_ATTACH
		WHERE  SEQ = #{id}
	</delete>

	<!-- 특정 파일 수정용 삭제 -->
	<delete id="deleteAttachForEdit" parameterType="java.util.Map">
		DELETE
		FROM   GC_ATTACH
		WHERE
		BUSINESS_CODE = #{refType,typeHandler=refTypeEnumHandler}
		AND REFERENCE_SEQ = #{referenceId}
		<if test="idList != null">
			AND SEQ NOT IN
			<foreach collection="idList" index="index" item="id" open="(" separator="," close=")">
				#{id}
			</foreach>
		</if>

	</delete>

	<!-- 특정 게시물에 해당하는 첨부파일 삭제 -->
	<delete id="deleteAttachReference" parameterType="long">
		DELETE
		FROM   GC_ATTACH
		WHERE  REFERENCE_SEQ = #{reference}
		AND BUSINESS_CODE = #{refType,typeHandler=refTypeEnumHandler}
	</delete>

	<update id="updateAttach" parameterType="attach">
	<![CDATA[
		UPDATE GC_ATTACH SET
			REF_TYPE = #{refType,typeHandler=refTypeEnumHandler},
			REF_KEY = #{refKey},
			TYPE_KEY = #{typeKey},
			DISPLAY_NAME = #{displayName},
			FILE_NAME = #{savedName},
			FILE_PATH = #{savedDir},
			FILE_TYPE = #{fileType},
			FILE_SIZE = #{fileSize,jdbcType=NUMERIC}
		where SEQ = #{id,jdbcType=NUMERIC}
	]]>
	</update>

</mapper>