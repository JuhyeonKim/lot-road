<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.nagesoft.postcode.code.dao.CommonCodeDAO">
	<resultMap id="simpleCommonCodeResultMap" type="com.nagesoft.postcode.code.model.CommonCode">
		<result property="code" column="C_COMM_CD" />
		<result property="alias" column="C_CD_ALAS" />
		<result property="parent.code" column="C_PRNT_CD" />
		<result property="name" column="C_CD_NM" />
		<result property="sortOrder" column="C_SRT_ORDR" />
		<result property="level" column="C_LVL" />
		<result property="useYN" column="C_USE_YN" />
	</resultMap>

	<resultMap id="defaultCommonCodeResultMap" type="com.nagesoft.postcode.code.model.CommonCode" extends="simpleCommonCodeResultMap">
		<result property="parent.name" column="P_CD_NM" />
		<result property="description" column="C_DESC" />
		<result property="sortOrder" column="C_SRT_ORDR" />
		<result property="useYN" column="C_USE_YN" />
		<result property="regUser.sequence" column="C_REG_SEQ" />
		<result property="regUser.managerID" column="R_MGR_ID" />
		<result property="regUser.managerName" column="R_MGR_NM" />
		<result property="regDate" column="C_REG_DT" />
		<result property="modUser.sequence" column="C_MOD_SEQ" />
		<result property="modUser.managerID" column="U_MGR_ID" />
		<result property="modUser.managerName" column="U_MGR_NM" />
		<result property="modDate" column="C_MOD_DT" />
	</resultMap>

	<resultMap id="commonCodeResultMap" type="com.nagesoft.postcode.code.model.CommonCode" extends="defaultCommonCodeResultMap">
		<result property="parent.level" column="P_LVL" />
		<result property="parent.sortOrder" column="P_SRT_ORDR" />
	</resultMap>

	<resultMap id="simpleCommonCodeWithMaxSort" type="com.nagesoft.postcode.code.model.CommonCode" extends="simpleCommonCodeResultMap">
		<result property="maxSortOrder" column="C_MAX_SRT_ORDR" />
	</resultMap>

	<sql id="selectQuery">
		SELECT  C.COMM_CD AS C_COMM_CD
			   ,C.CD_ALAS AS C_CD_ALAS
		       ,C.PRNT_CD AS C_PRNT_CD
		       ,P.CD_NM AS P_CD_NM
			   ,P.LVL AS P_LVL
			   ,P.SRT_ORDR AS P_SRT_ORDR
		       ,C.CD_NM AS C_CD_NM
		       ,C.LVL AS C_LVL
		       ,C.CD_DESC AS C_DESC
		       ,C.SRT_ORDR AS C_SRT_ORDR
		       ,C.USE_YN AS C_USE_YN
		       ,C.REG_SEQ AS C_REG_SEQ
		       ,C.REG_DT AS C_REG_DT
		       ,C.MOD_SEQ AS C_MOD_SEQ
		       ,C.MOD_DT AS C_MOD_DT
		FROM   GC_COMM_CD C LEFT OUTER JOIN GC_COMM_CD P ON C.PRNT_CD = P.COMM_CD
	</sql>

	<sql id="defaultCondition">
		<where>
		    <if test="useYN != null">
			    AND C.USE_YN = #{useYN}
		    </if>
			<if test="code != null">
				AND C.COMM_CD = #{code}
			</if>
			<if test="parentCode != null">
				P.COMM_CD = #{parentCode}
			</if>
	   	</where>
	</sql>

	<!-- 공통코드 등록 -->
    <insert id="insertCommonCode">
	    -- insertCommonCode
	    INSERT INTO GC_COMM_CD (
		    PRNT_CD,
		    CD_ALAS,
		    COMM_CD,
		    CD_NM,
		    CD_DESC,
		    LVL,
		    SRT_ORDR,
		    REG_SEQ,
		    REG_DT
	    ) VALUES (
		    #{parent.code},
		    #{alias},
		    #{code},
		    #{name},
		    #{description},
		    #{level},
		    #{sortOrder},
		    #{regUser.sequence},
		    NOW()
		)
    </insert>

	<!-- 공통코드 목록 조회 -->
    <select id="getCodeList" resultMap="defaultCommonCodeResultMap">
	    -- getCodeList
	    <include refid="selectQuery" />

	    <include refid="defaultCondition" />

	    ORDER BY C.PRNT_CD IS NULL  DESC, P.SRT_ORDR ASC, C.PRNT_CD ASC , C.SRT_ORDR ASC, C.COMM_CD ASC
    </select>

	<!-- 공통코드 상세 조회 -->
    <select id="getCode" resultMap="simpleCommonCodeWithMaxSort">
	    -- getCode
	    SELECT  C.COMM_CD AS C_COMM_CD
	           ,C.CD_ALAS AS C_CD_ALAS
	           ,C.PRNT_CD AS C_PRNT_CD
	           ,C.CD_NM AS C_CD_NM
	           ,C.SRT_ORDR AS C_SRT_ORDR
	           ,C.LVL AS C_LVL
	           ,C.USE_YN AS C_USE_YN
	           ,(
	               SELECT IFNULL(MAX(SRT_ORDR), 0)
	               FROM   GC_COMM_CD
	               WHERE  PRNT_CD = #{code}
	    	   ) AS C_MAX_SRT_ORDR
	    FROM   GC_COMM_CD C

	    <include refid="defaultCondition" />
    </select>

    <select id="getCommonCodeCount" resultType="java.lang.Integer">
	    SELECT COUNT(*)
	    FROM   GC_COMM_CD
	    WHERE  PRNT_CD = #{code}
    </select>

	<!-- 공통코드 수정 처리 -->
	<update id="updateCommonCode">
		-- updateCommonCode
	    UPDATE GC_COMM_CD
	       SET CD_NM = #{name},
		       SRT_ORDR = #{sortOrder},
		       USE_YN = #{useYN},
		       MOD_SEQ = #{modUser.sequence},
		       MOD_DT = NOW()
	           <if test="alias != null">
		           , CD_ALAS = #{alias}
	           </if>
	    WHERE  COMM_CD = #{code}
    </update>

	<!-- 정렬 순서 일괄 변경 -->
	<update id="updateNextSortOrderAll">
    	-- updateNextSortOrderAll
	    UPDATE GC_COMM_CD
	       SET SRT_ORDR = SRT_ORDR + 1,
		       MOD_SEQ = #{modUser.sequence},
		       MOD_DT = NOW()
	    WHERE  SRT_ORDR &gt;= #{currentSortOrder}
	       AND PRNT_CD = #{code}
    </update>

	<update id="updateNextSortOrder">
	    UPDATE GC_COMM_CD
	       SET SRT_ORDR = SRT_ORDR -1,
		       MOD_SEQ = #{modUser.sequence},
		       MOD_DT = NOW()
	    WHERE  SRT_ORDR &gt; #{from}
	       AND SRT_ORDR &lt;= #{to}
	       AND PRNT_CD = #{code}
    </update>

	<update id="updateBeforeSortOrder">
	    -- updateNextSortOrder
	    UPDATE GC_COMM_CD
	       SET SRT_ORDR = SRT_ORDR + 1,
		       MOD_SEQ = #{modUser.sequence},
		       MOD_DT = NOW()
	    WHERE  SRT_ORDR &gt;= #{from}
	       AND SRT_ORDR &lt; #{to}
	       AND PRNT_CD = #{code}
    </update>

	<update id="updateUseYNAllChild">
		UPDATE GC_COMM_CD
		   SET USE_YN = #{useYN}
		WHERE  PRNT_CD = #{code}
	</update>
</mapper>